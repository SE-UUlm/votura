name: Testing API

on:
  workflow_dispatch:
  push:
  merge_group:

jobs:
  test:
    name: Testing API Endpoints
    runs-on:
      labels: ubuntu-latest
    container:
      image: ubuntu:24.04
    continue-on-error: false
    timeout-minutes: 15

    steps:
      - name: Update & install apt packages
        run: |
          apt-get update
          apt-get install -y wget unzip
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install npm dependencies
        run: npm ci
      - name: Build all packages
        run: |
          npm run build
      - name: Run API tests
        run: |
          cd apps/backend
          npm run start &
          sleep 5
          npm run test-api
